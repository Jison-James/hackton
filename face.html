<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Emotion Mimic Challenge</title>
<style>
:root{
  --bg:#0b1220; --card:#0f1720; --accent:#4aa3ff;
  --muted:#9aa6b2; --white:#e7f0ff; --success:#4aff9a; --fail:#ff4a6a;
}
body {
  margin:0;
  font-family:Inter,system-ui,Arial;
  background:linear-gradient(180deg,var(--bg),#071019);
  color:var(--white);
  padding:20px;
}
.wrap {
  max-width:950px;
  margin:auto;
  background: rgba(255,255,255,0.02);
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(0,0,0,0.4);
}
h1 {margin-bottom:5px}
.lead {color:var(--muted);margin-bottom:20px}
.grid {display:grid;gap:20px;grid-template-columns:1fr 350px}
.camera {
  background:var(--card);
  padding:12px;
  border-radius:12px;
  position:relative;
}
video {width:100%;border-radius:8px;background:#000}
.target-box {
  text-align:center;
  padding:10px;
  background:rgba(255,255,255,0.05);
  border-radius:8px;
  margin-bottom:10px;
  border: 2px dashed var(--accent);
}
.target-emoji {
  font-size:70px;
}
.btn {
  padding:8px 12px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.06);
  background:transparent;
  color:var(--white);
  cursor:pointer;
  transition:0.2s;
}
.btn:hover {transform:scale(1.05)}
.btn.primary {
  background:linear-gradient(90deg,var(--accent),#6ad);
  border:0;
  color:#000;
  font-weight:bold;
}
.btn.ghost {background:transparent;border:1px solid rgba(255,255,255,0.06)}
.status {margin-top:8px;color:var(--muted);font-size:14px}
.results {
  background:rgba(255,255,255,0.02);
  padding:12px;
  border-radius:12px;
}
.ranking{margin-top:10px}
.bar {display:flex;align-items:center;gap:8px;margin-bottom:6px}
.bar .label {width:90px;color:var(--muted)}
.bar .meter {
  flex:1;
  height:12px;
  background:#031018;
  border-radius:8px;
  overflow:hidden;
}
.bar .fill {
  height:100%;
  background:linear-gradient(90deg,var(--accent),#6ad);
  transition: width 0.6s ease;
}
.result-message {
  margin-top: 15px;
  font-size: 20px;
  font-weight: bold;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}
.win {background:rgba(74,255,154,0.15);color:var(--success)}
.fail {background:rgba(255,74,106,0.15);color:var(--fail)}
.cutoff-select {
  margin-left:auto;
  background:rgba(255,255,255,0.05);
  color:var(--white);
  border-radius:6px;
  padding:4px 8px;
  border:1px solid rgba(255,255,255,0.08);
}
.detail-analysis {
  margin-top:12px;
  padding:10px;
  background:rgba(255,255,255,0.03);
  border-radius:8px;
  font-size:14px;
  color:var(--muted);
}
@media(max-width:800px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1 style="display:flex;align-items:center;gap:10px">
    üéØ Emotion Mimic Challenge
    <select id="cutoff-select" class="cutoff-select">
      <option value="50">Pass ‚â• 50%</option>
      <option value="70">Pass ‚â• 70%</option>
      <option value="80" selected>Pass ‚â• 80%</option>
      <option value="90">Pass ‚â• 90%</option>
    </select>
  </h1>

  <!-- üîô Back Button -->
  <div style="margin-bottom:15px;">
    <button onclick="window.location.href='index.html'" 
      style="
        padding:8px 14px;
        border-radius:6px;
        border:none;
        background:linear-gradient(90deg,var(--accent),#6ad);
        color:#000;
        font-weight:bold;
        cursor:pointer;
        transition:0.2s;
      "
      onmouseover="this.style.transform='scale(1.05)'"
      onmouseout="this.style.transform='scale(1)'"
    >üè† Back to Home</button>
  </div>

  <p class="lead">Mimic the shown emotion. Pass if your score meets or exceeds the cutoff.</p>
  
  <div class="grid">
    <div class="camera">
      <div class="target-box">
        <div>Target Emotion:</div>
        <div id="target-emoji" class="target-emoji">üôÇ</div>
        <div id="target-label" style="margin-top:5px;font-weight:bold"></div>
      </div>
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas" width="640" height="480" hidden></canvas>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="start-btn" class="btn">Start Camera</button>
        <button id="new-target-btn" class="btn ghost" disabled>üé≤ New Target</button>
        <button id="snap-btn" class="btn primary" disabled>üì∏ Capture & Evaluate</button>
        <button id="stop-btn" class="btn ghost" disabled>Stop</button>
      </div>
      <div id="status" class="status">Idle</div>
    </div>

    <div class="results">
      <h2>Result</h2>
      <div id="game-result" class="result-message"></div>
      <div id="ranking" class="ranking"></div>
      <div id="detail-analysis" class="detail-analysis"></div>
    </div>
  </div>
</div>

<script>
const GEMINI_API_KEY = "AIzaSyDlCpqymj5ILrYFgoUxf2113x2tw0l9ETk"; 
const GEMINI_MODEL = "gemini-2.0-flash";

const TARGET_EMOTIONS = [
  {name:"happy", emoji:"üòÄ"},
  {name:"sad", emoji:"üò¢"},
  {name:"angry", emoji:"üò°"},
  {name:"surprised", emoji:"üò≤"},
  {name:"neutral", emoji:"üòê"},
  {name:"disgust", emoji:"ü§¢"},
  {name:"fear", emoji:"üò®"}
];

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const startBtn = document.getElementById('start-btn');
const newTargetBtn = document.getElementById('new-target-btn');
const snapBtn = document.getElementById('snap-btn');
const stopBtn = document.getElementById('stop-btn');
const statusEl = document.getElementById('status');
const rankingEl = document.getElementById('ranking');
const targetEmoji = document.getElementById('target-emoji');
const targetLabel = document.getElementById('target-label');
const gameResult = document.getElementById('game-result');
const cutoffSelect = document.getElementById('cutoff-select');
const detailAnalysis = document.getElementById('detail-analysis');

let stream = null;
let currentTarget = null;

function setStatus(s){ statusEl.textContent = s; }
function pickRandomTarget(){
  currentTarget = TARGET_EMOTIONS[Math.floor(Math.random()*TARGET_EMOTIONS.length)];
  targetEmoji.textContent = currentTarget.emoji;
  targetLabel.textContent = currentTarget.name.toUpperCase();
}

async function startCamera(){
  try {
    stream = await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject = stream;
    startBtn.disabled = true;
    snapBtn.disabled = false;
    stopBtn.disabled = false;
    newTargetBtn.disabled = false;
    pickRandomTarget();
    setStatus("Camera started");
  } catch(err){
    setStatus("Camera error: " + err.message);
  }
}
function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  video.srcObject = null;
  startBtn.disabled = false;
  snapBtn.disabled = true;
  stopBtn.disabled = true;
  newTargetBtn.disabled = true;
  setStatus("Camera stopped");
}
function captureImage(){
  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
  return canvas.toDataURL('image/jpeg', 0.85);
}

async function evaluate(){
  if(!currentTarget){ setStatus("No target selected"); return; }
  setStatus("Capturing...");
  const imgBase64 = captureImage().replace(/^data:image\/jpeg;base64,/, "");
  setStatus("Processing...");
  rankingEl.innerHTML = "";
  gameResult.textContent = "";
  detailAnalysis.textContent = "";

  const prompt = `
Analyze the face in this image and return ONLY JSON in this format:
{
  "top_emotion": "<happy|sad|angry|surprised|neutral|disgust|fear>",
  "top_score": <float 0-1>,
  "emotions": {
    "happy": <float>,
    "sad": <float>,
    "angry": <float>,
    "surprised": <float>,
    "neutral": <float>,
    "disgust": <float>,
    "fear": <float>
  },
  "analysis": "<one short sentence describing why AI thinks it's this emotion>"
}
If no human face detected: {"error":"no_face_detected"}
`;

  try {
    const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        contents: [{
          role: "user",
          parts: [
            { inline_data: { mime_type: "image/jpeg", data: imgBase64 } },
            { text: prompt }
          ]
        }],
        generation_config: { response_mime_type: "application/json" }
      })
    });

    if(!resp.ok) throw new Error(await resp.text());
    const data = await resp.json();
    const textPart = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
    let parsed;
    try { parsed = JSON.parse(textPart.trim()); }
    catch(e) { throw new Error("Could not parse JSON: " + textPart); }

    if(parsed.error){ setStatus("No face detected"); return; }

    const em = parsed.emotions || {};
    const targetScore = Math.round((em[currentTarget.name] || 0) * 100);
    const cutoff = parseInt(cutoffSelect.value);
    
    let resultHTML = `
      <div style="margin-bottom:10px;font-size:16px;line-height:1.6">
        <strong>üéØ Target:</strong> ${currentTarget.name.toUpperCase()}<br>
        <strong>ü§ñ AI Detected:</strong> ${parsed.top_emotion.toUpperCase()} (${Math.round(parsed.top_score * 100)}%)<br>
        <strong>üìä Match:</strong> ${targetScore}%
      </div>
    `;

    if (targetScore >= cutoff) {
      gameResult.textContent = `üéâ Match: ${targetScore}% ‚Äî You Passed!`;
      gameResult.className = "result-message win";
    } else {
      gameResult.textContent = `‚ùå Match: ${targetScore}% ‚Äî You Failed!`;
      gameResult.className = "result-message fail";
    }

    const keys = Object.keys(em).sort((a,b) => em[b] - em[a]);
    rankingEl.innerHTML = resultHTML + keys.map(k => {
      const pct = Math.round((em[k] || 0) * 100);
      const highlight = (k === currentTarget.name) ? "box-shadow:0 0 8px var(--accent);" : "";
      return `<div class="bar" style="${highlight}">
        <div class="label">${k}</div>
        <div class="meter"><div class="fill" style="width:${pct}%"></div></div>
        <div style="width:40px;text-align:right">${pct}%</div>
      </div>`;
    }).join("");

    const secondBest = keys[1] ? { name: keys[1], score: Math.round(em[keys[1]]*100) } : null;
    let analysisText = parsed.analysis ? parsed.analysis + " " : "";
    analysisText += `Your ${currentTarget.name} score was ${targetScore}%. `;
    if (secondBest) {
      analysisText += `The next closest emotion was ${secondBest.name} (${secondBest.score}%), a difference of ${targetScore - secondBest.score} points.`;
    }
    detailAnalysis.textContent = analysisText;

    setStatus(`Top emotion: ${parsed.top_emotion} (${Math.round(parsed.top_score*100)}%)`);
  } catch(err){
    console.error(err);
    setStatus("Error: " + err.message);
  }
}

startBtn.addEventListener('click', startCamera);
stopBtn.addEventListener('click', stopCamera);
snapBtn.addEventListener('click', evaluate);
newTargetBtn.addEventListener('click', pickRandomTarget);
</script>
</body>
</html>
